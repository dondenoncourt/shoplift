// This could work without jQuery, but why? it only costs us afew extra ms.
(function(window) {

  var TheShopLift = TheShopLift || {};

// TODO: less hacky lazy load
  var image = new Image();
  image.setAttribute('src','<%= root_url %>/assets/ajax-loader.gif');
// /TODO

  window.TheShopLift = TheShopLift;

  // don't check if already loaded, simply remove
  TheShopLift.Bookmarklet = {
    config: {
      url: '<%= root_url %>',
      jquery: '//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js'
    },
    element: null,
    state: 'idle',

    containerCss: {

      /* Reset */
      'margin': 0,
      'padding': 0,
      'border': 0,
      'font-size': '100%',
      'font': 'inherit',
      'vertical-align':' baseline',
      'display': 'block',

      'top': 0,
      'left': 0,
      'position': 'absolute',
      'width': '100%',
      'height': '100%',
      'z-index': '999999999999',
      'filter': 'progid:DXImageTransform.Microsoft.gradient(startColorstr=#50990000,endColorstr=#50990000)',
      'zoom': 1,
      'background-color': 'rgba(0,0,0,0.8)',
      'background-image': 'url(<%= root_url %>/assets/ajax-loader.gif)',
      'background-position': '50% 50%',
      'background-repeat': 'no-repeat'
    },

    iframeCss: {

      /* Reset */
      'margin': 0,
      'padding': 0,
      'border': 0,
      'font-size': '100%',
      'font': 'inherit',
      'vertical-align':' baseline',
      'display': 'block',

      'position': 'fixed',
      'top': '50%',
      'left': '50%',
      'width': '500px',
      'height': '500px',
      'margin-top': '-200px',
      'margin-left': '-200px',
      'z-index': '9999999999999',
      'background': 'transparent'
    },

    containerHtml: '<div id="the-shoplift-container"></div>',
    iframeHtml:    "<iframe id='the-shoplift-iframe' src='<%= bookmarklet_iframe_url %>' frameborder='0' scrolling='no' style='visibility:hidden;';\"></iframe>"
  };

  var B = TheShopLift.Bookmarklet;

  // may aswell just inline jquery here
  function loadJQuery() {
    var script = window.document.createElement("script"),
    done  = false;

    script.setAttribute("src", TheShopLift.Bookmarklet.config.jquery);

    script.onload = script.onreadystatechange = function() {
      if (!done && (!this.readyState || this.readyState == "loaded" || this.readyState == "complete")) {
        done = true;

        B.$ = jQuery.noConflict(true);
        setTimeout(ready,0);
      }
    };

    window.document.body.appendChild(script);
  }

  function show(){

    B.$(document.body).append(B.container);

    B.container.css(B.containerCss);

    B.$(B.iframe).load(function(){
      B.container.css({
        'background-image': 'none'
      });

      B.iframe.css({
        'visibility': 'visible' /* prevent iframe flickering */
      });
    });

    B.container.
      append(B.iframe.css(B.iframeCss)).
      click(function(e){
        var element = $(this);

        element.remove()
    });

  }

  function build() {
    B.container = B.$(B.containerHtml);
    B.iframe    = B.$(B.iframeHtml);
  }

  function ready() {
    build();
    show();
  }

  function boot()  {
    loadJQuery();
  }

  boot();

  // export
  B.boot = boot, B.ready = ready, B.show = show, B.build = build;

})(window);
